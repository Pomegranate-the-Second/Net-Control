<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internet Speed Meter - измеритель скорости интернета</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .leaflet-control-attribution {
            display: none !important;
        }
        
        /* Основной контейнер с двумя колонками */
        .main-container {
            display: flex;
            height: calc(100vh - 80px);
            width: 100%;
            overflow: hidden;
        }
        
        /* Левая панель с данными */
        .left-panel {
            width: 30%;
            min-width: 350px;
            background-color: white;
            overflow-y: auto;
            padding: 20px;
            border-right: 1px solid #e5e7eb;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }
        
        /* Правая панель с картой */
        .right-panel {
            width: 70%;
            background-color: #f8fafc;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        
        /* Стили для карты */
        #map {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .map-container {
            position: relative;
            height: 100%;
        }
        
        /* Заголовок в левой панели */
        .left-panel h2 {
            color: #1e40af;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        /* Стили для данных о точке */
        .point-data {
            background-color: #f9fafb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .point-data:hover {
            background-color: #eff6ff;
            transform: translateY(-2px);
        }
        
        .point-data.active {
            background-color: #eff6ff;
            border-left-color: #1d4ed8;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        }
        
        .point-data h3 {
            color: #1f2937;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .data-item {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        
        .data-label {
            color: #6b7280;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .data-value {
            color: #111827;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        /* Уведомление при отсутствии данных */
        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }
        
        .no-data i {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        /* Иконка сотового телефона для маркеров */
        .cell-icon {
            background-color: #3b82f6;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        /* Шапка остается без изменений */
        header {
            background-color: white;
            padding: 16px 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .header-container {
            max-width: 100%;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Убираем лишние рамки из оригинального кода */
        .custom-border {
            border: none;
            border-radius: 0;
        }
        
        .custom-shadow {
            box-shadow: none;
        }
        
        /* Адаптивность для мобильных устройств */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                height: auto;
            }
            
            .left-panel, .right-panel {
                width: 100%;
                min-width: auto;
                height: 50vh;
            }
            
            .left-panel {
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }
            
            .map-controls {
                top: 5px;
                right: 5px;
                padding: 6px;
            }
            
            .map-controls button {
                font-size: 11px;
                padding: 4px 8px;
            }
        }
        
        /* Стили для управления картой */
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .map-controls button {
            padding: 8px 14px;
            font-size: 13px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .map-controls button:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(37, 99, 235, 0.3);
        }
        
        .map-controls button:active {
            transform: translateY(0);
        }
        
        /* Стили для слоев карты */
        .leaflet-control-layers {
            border-radius: 6px !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
        }
        
        /* Поиск по карте */
        .search-container {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 1000;
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            width: 300px;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .search-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Улучшенный попап */
        .leaflet-popup-content {
            min-width: 200px;
        }
        
        .popup-content {
            padding: 5px;
        }
        
        .popup-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .popup-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 13px;
        }
        
        .popup-label {
            color: #6b7280;
        }
        
        .popup-value {
            color: #111827;
            font-weight: 500;
        }
        
        /* Информация о координатах */
        .coordinates-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #374151;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 250px;
        }
    </style>
    <script>
    // Основные переменные
    let points = [];
    let currentPointId = 2; // Начинаем с 2, так как уже есть 2 точки
    let map;
    let markersLayer;
    let activePointId = null;
    
    // Функция для отображения данных точки в левой панели
    function showPointData(point) {
        const dataContainer = document.getElementById('point-data-container');
        
        // Удаляем активный класс у всех точек
        document.querySelectorAll('.point-data').forEach(el => {
            el.classList.remove('active');
        });
        
        // Проверяем, существует ли уже элемент для этой точки
        const existingElement = document.querySelector(`[data-point-id="${point.id}"]`);
        
        if (existingElement) {
            // Если элемент уже существует, обновляем его и делаем активным
            existingElement.innerHTML = `
                <h3>${point.title || 'Точка связи'}</h3>
                <div class="data-item">
                    <span class="data-label">ID объекта:</span>
                    <span class="data-value">${point.objectId || 'Не указан'}</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Широта:</span>
                    <span class="data-value">${point.lat.toFixed(6)}</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Долгота:</span>
                    <span class="data-value">${point.lng.toFixed(6)}</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Регион:</span>
                    <span class="data-value">${point.region || 'Не указан'}</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Технологии:</span>
                    <span class="data-value">${point.technologies || 'Не указаны'}</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Статус:</span>
                    <span class="data-value">${point.status || 'Активна'}</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Адрес:</span>
                    <span class="data-value">${point.address || 'Не определен'}</span>
                </div>
            `;
            existingElement.classList.add('active');
            existingElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            // Создаем новый элемент с данными точки
            const pointElement = document.createElement('div');
            pointElement.className = 'point-data active';
            pointElement.dataset.pointId = point.id;
            
            pointElement.innerHTML = `
                <h3>${point.title || 'Точка связи'}</h3>
                <div class="data-item">
                    <span class="data-label">ID объекта:</span>
                    <span class="data-value">${point.objectId || 'Не указан'}</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Широта:</span>
                    <span class="data-value">${point.lat.toFixed(6)}</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Долгота:</span>
                    <span class="data-value">${point.lng.toFixed(6)}</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Регион:</span>
                    <span class="data-value">${point.region || 'Не указан'}</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Технологии:</span>
                    <span class="data-value">${point.technologies || 'Не указаны'}</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Статус:</span>
                    <span class="data-value">${point.status || 'Активна'}</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Адрес:</span>
                    <span class="data-value">${point.address || 'Не определен'}</span>
                </div>
            `;
            
            // Добавляем обработчик клика для выделения точки на карте
            pointElement.addEventListener('click', function() {
                highlightPointOnMap(point.id);
            });
            
            // Добавляем данные в начало контейнера
            dataContainer.insertBefore(pointElement, dataContainer.firstChild);
            
            // Если слишком много элементов, удаляем самый старый
            if (dataContainer.children.length > 15) {
                dataContainer.removeChild(dataContainer.lastChild);
            }
        }
        
        // Обновляем заголовок левой панели
        document.getElementById('left-panel-title').textContent = `Анализ измерений (${points.length})`;
        activePointId = point.id;
    }
    
    // Функция для выделения точки на карте
    function highlightPointOnMap(pointId) {
        const point = points.find(p => p.id === pointId);
        if (point && point.marker) {
            // Центрируем карту на точке
            map.setView([point.lat, point.lng], 17);
            
            // Открываем попап
            point.marker.openPopup();
            
            // Анимируем маркер
            const icon = point.marker.getElement();
            if (icon) {
                icon.style.animation = 'pulse 0.5s 3';
                setTimeout(() => {
                    icon.style.animation = '';
                }, 1500);
            }
        }
    }
    
    // Функция для создания кастомной иконки сотового телефона
    function createCellIcon(color = '#3b82f6') {
        return L.divIcon({
            className: 'custom-cell-icon',
            html: `<div class="cell-icon" style="background-color: ${color};"><i class="fas fa-mobile-screen"></i></div>`,
            iconSize: [36, 36],
            iconAnchor: [18, 18],
            popupAnchor: [0, -18]
        });
    }
    
    // Функция получения адреса по координатам (обратное геокодирование)
    async function getAddressFromCoordinates(lat, lng) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
            const data = await response.json();
            
            if (data && data.address) {
                const address = data.address;
                let addressStr = '';
                
                if (address.road) addressStr += address.road;
                if (address.house_number) addressStr += `, ${address.house_number}`;
                if (!addressStr && address.city) addressStr = address.city;
                
                return addressStr || 'Адрес не найден';
            }
            return 'Адрес не найден';
        } catch (error) {
            console.error('Ошибка получения адреса:', error);
            return 'Ошибка получения адреса';
        }
    }
    
    // Инициализация карты
    function initMap() {
        // Устанавливаем центр на Таганрог (45.2052, 38.9407)
        map = L.map('map').setView([47.2052, 38.9407], 15);
        
        // Добавляем несколько источников карт
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        });
        
        const osmHotLayer = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors, Tiles style by Humanitarian OpenStreetMap Team',
            maxZoom: 19
        });
        
        const cartoDbLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap, © CartoDB',
            subdomains: 'abcd',
            maxZoom: 19
        });
        
        // Добавляем слой по умолчанию
        osmLayer.addTo(map);
        
        // Добавляем контроль слоев
        const baseLayers = {
            "OpenStreetMap": osmLayer,
            "OpenStreetMap H.O.T.": osmHotLayer,
            "CartoDB Light": cartoDbLayer
        };
        
        L.control.layers(baseLayers).addTo(map);
        
        // Создаем слой для маркеров
        markersLayer = L.layerGroup().addTo(map);
        
        // Добавляем информацию о координатах
        const coordsInfo = L.control({position: 'bottomleft'});
        coordsInfo.onAdd = function() {
            this._div = L.DomUtil.create('div', 'coordinates-info');
            this.update();
            return this._div;
        };
        coordsInfo.update = function(latlng) {
            if (latlng) {
                this._div.innerHTML = `Широта: ${latlng.lat.toFixed(6)}<br>Долгота: ${latlng.lng.toFixed(6)}`;
            } else {
                this._div.innerHTML = 'Кликните на карту для координат';
            }
        };
        coordsInfo.addTo(map);
        
        // Обновляем координаты при движении мыши по карте
        map.on('mousemove', function(e) {
            coordsInfo.update(e.latlng);
        });
        
        // Добавляем две начальные точки в Таганроге с адресами
        const initialPoints = [
            {
                id: 1,
                lat: 47.2052,
                lng: 38.9407,
                title: 'Измерение',
                objectId: 'ТГР-ЦЕНТР',
                region: 'Таганрог, Ростовская область',
                technologies: '4G, LTE, 5G',
                status: 'Активна',
                address: 'ул. Петровская, 10'
            },
            {
                id: 2,
                lat: 47.2050,
                lng: 38.9404,
                title: 'Измерение',
                objectId: 'ТГР-СЕВЕР',
                region: 'Таганрог, Ростовская область',
                technologies: '3G, 4G, Wi-Fi',
                status: 'В разработке',
                address: 'пр-т Ленина, 45'
            }
        ];
        
        // Добавляем начальные точки на карту
        initialPoints.forEach(async point => {
            points.push(point);
            await addPointToMap(point);
            showPointData(point);
        });
        
        // Обработчик клика по карте для добавления новых точек
        map.on('click', async function(e) {
            currentPointId++;
            const address = await getAddressFromCoordinates(e.latlng.lat, e.latlng.lng);
            
            const newPoint = {
                id: currentPointId,
                lat: e.latlng.lat,
                lng: e.latlng.lng,
                title: `Новая точка связи #${currentPointId}`,
                objectId: `АВТО-${currentPointId.toString().padStart(3, '0')}`,
                region: 'Таганрог, Ростовская область',
                technologies: '2G, 3G, 4G',
                status: 'Новая',
                address: address
            };
            
            await addPointToMap(newPoint);
            showPointData(newPoint);
            
            // Центрируем карту на новой точке с увеличением
            map.setView([newPoint.lat, newPoint.lng], 17);
        });
        
        // Кнопка очистки всех точек
        document.getElementById('clear-points').addEventListener('click', function() {
            if (confirm('Вы уверены, что хотите удалить все точки?')) {
                markersLayer.clearLayers();
                points = [];
                currentPointId = 2;
                document.getElementById('point-data-container').innerHTML = '';
                document.getElementById('left-panel-title').textContent = 'Данные по точкам (0)';
                activePointId = null;
            }
        });
        
        return { map, markersLayer };
    }
    
    // Функция для добавления точки на карту
    async function addPointToMap(point) {
        // Определяем цвет маркера в зависимости от статуса
        let markerColor = '#3b82f6'; // Синий по умолчанию
        if (point.status === 'Активна') markerColor = '#10b981'; // Зеленый
        if (point.status === 'В разработке') markerColor = '#f59e0b'; // Желтый
        if (point.status === 'Новая') markerColor = '#8b5cf6'; // Фиолетовый
        
        // Создаем маркер с иконкой сотового телефона
        const marker = L.marker([point.lat, point.lng], {
            icon: createCellIcon(markerColor),
            draggable: true
        }).addTo(markersLayer);
        
        // Сохраняем ссылку на маркер в объекте точки
        point.marker = marker;
        
        // Получаем адрес, если его нет
        if (!point.address || point.address === 'Не определен') {
            point.address = await getAddressFromCoordinates(point.lat, point.lng);
        }
        
        // Добавляем всплывающее окно с улучшенным дизайном
        marker.bindPopup(`
            <div class="popup-content">
                <div class="popup-title">${point.title}</div>
                <div class="popup-detail">
                    <span class="popup-label">ID:</span>
                    <span class="popup-value">${point.objectId}</span>
                </div>
                <div class="popup-detail">
                    <span class="popup-label">Координаты:</span>
                    <span class="popup-value">${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}</span>
                </div>
                <div class="popup-detail">
                    <span class="popup-label">Технологии:</span>
                    <span class="popup-value">${point.technologies}</span>
                </div>
                <div class="popup-detail">
                    <span class="popup-label">Статус:</span>
                    <span class="popup-value">${point.status}</span>
                </div>
                <div class="popup-detail">
                    <span class="popup-label">Адрес:</span>
                    <span class="popup-value">${point.address}</span>
                </div>
            </div>
        `);
        
        // Обработчик клика по маркеру
        marker.on('click', function() {
            showPointData(point);
        });
        
        // Обработчик перемещения маркера
        marker.on('dragend', async function(e) {
            const newLat = e.target.getLatLng().lat;
            const newLng = e.target.getLatLng().lng;
            
            // Обновляем координаты точки
            point.lat = newLat;
            point.lng = newLng;
            
            // Получаем новый адрес
            point.address = await getAddressFromCoordinates(newLat, newLng);
            
            // Обновляем данные в левой панели, если эта точка активна
            if (activePointId === point.id) {
                showPointData(point);
            }
        });
        
        // Добавляем точку в массив
        points.push(point);
    }
    
    // Функция поиска по адресу
    async function searchAddress() {
        const searchInput = document.getElementById('search-input');
        const query = searchInput.value.trim();
        
        if (!query) return;
        
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
            const data = await response.json();
            
            if (data && data.length > 0) {
                const result = data[0];
                map.setView([result.lat, result.lon], 17);
                
                // Добавляем временный маркер
                const tempMarker = L.marker([result.lat, result.lon], {
                    icon: L.divIcon({
                        html: '<div style="background-color: #ef4444; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);
                
                tempMarker.bindPopup(`<b>Найдено:</b><br>${result.display_name}`).openPopup();
                
                // Удаляем маркер через 5 секунд
                setTimeout(() => {
                    map.removeLayer(tempMarker);
                }, 5000);
            } else {
                alert('Адрес не найден');
            }
        } catch (error) {
            console.error('Ошибка поиска:', error);
            alert('Ошибка при поиске адреса');
        }
    }
    
    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        // Инициализируем карту
        const { map: leafletMap, markersLayer } = initMap();
        
        // Добавляем поиск
        const searchContainer = document.createElement('div');
        searchContainer.className = 'search-container';
        searchContainer.innerHTML = `
            <input type="text" 
                   id="search-input" 
                   class="search-input" 
                   placeholder="Поиск адреса или места..."
                   onkeypress="if(event.key === 'Enter') searchAddress()">
        `;
        document.querySelector('.map-container').appendChild(searchContainer);
        
        // Добавляем кнопку для возврата к Таганрогу
        const backToTaganrogBtn = document.createElement('button');
        backToTaganrogBtn.id = 'back-to-taganrog';
        backToTaganrogBtn.textContent = 'Вернуться в Таганрог';
        backToTaganrogBtn.title = 'Центрировать карту на Таганроге';
        document.querySelector('.map-controls').appendChild(backToTaganrogBtn);
        
        // Обработчик для кнопки возврата
        document.getElementById('back-to-taganrog').addEventListener('click', function() {
            leafletMap.setView([47.2052, 38.9406], 15);
        });
        
        // Добавляем анимацию пульсации
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.2); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);
    });
</script>
</head>

<body class="bg-white min-h-screen font-sans">
    <!-- Шапка с навигацией -->
    <header>
        <div class="header-container">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-xl">
                    <i class="fas fa-tower-cell"></i>
                </div>
                <h1 class="text-2xl font-bold text-blue-600 ml-3">Internet Speed Meter</h1>
            </div>
            
            <nav class="flex space-x-4">
                <button class="nav-btn p-2 rounded-full hover:bg-blue-50 transition-colors" title="Выход">
                    <i class="fas fa-sign-out-alt text-blue-600 text-xl"></i>
                </button>
            </nav>
        </div>
    </header>

    <!-- Основной контейнер с двумя панелями -->
    <div class="main-container">
        <!-- Левая панель с данными о точках -->
        <div class="left-panel">
            <h2 id="left-panel-title">Анализ измерений</h2>
            <div id="point-data-container">
                <!-- Данные будут добавляться динамически -->
            </div>
        </div>

        <!-- Правая панель с картой -->
        <div class="right-panel">
            <div class="map-container">
                <div id="map"></div>
                <div class="map-controls">
                    <button id="clear-points">Очистить все точки</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>