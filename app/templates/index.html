{% include "base.html" %}
{% include "panel.html" %}

    <!-- Основной контейнер с двумя панелями -->
    <div class="main-container">
        <!-- Левая панель с данными о точках -->
        <div class="left-panel">
            <h2 id="left-panel-title">Анализ измерений</h2>
            <div id="point-data-container">
                <!-- Данные будут добавляться динамически -->
            </div>
        </div>

        <!-- Правая панель с картой -->
        <div class="right-panel">
            <div class="map-container">
                <div id="map"></div>
                <!--<div class="map-controls">-->
                    <!--<button id="clear-points">Очистить все точки</button>-->
                <!--</div>-->
            </div>
        </div>
    </div>

    <script>
        // Основные переменные
        let points = [];
        let currentPointId = 2; // Начинаем с 2, так как уже есть 2 точки
        let map;
        let markersLayer;
        let activePointId = null;
        
        // Функция для отображения данных точки в левой панели
        function showPointData(point) {
            const dataContainer = document.getElementById('point-data-container');
            
            // Удаляем активный класс у всех точек
            document.querySelectorAll('.point-data').forEach(el => {
                el.classList.remove('active');
            });
            
            // Проверяем, существует ли уже элемент для этой точки
            const existingElement = document.querySelector(`[data-point-id="${point.id}"]`);
            
            if (existingElement) {
                // Если элемент уже существует, обновляем его и делаем активным
                existingElement.innerHTML = `
                    <h3>${point.title || 'Точка связи'}</h3>
                    <div class="data-item">
                        <span class="data-label">ID объекта:</span>
                        <span class="data-value">${point.objectId || 'Не указан'}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Широта:</span>
                        <span class="data-value">${point.lat.toFixed(6)}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Долгота:</span>
                        <span class="data-value">${point.lng.toFixed(6)}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Регион:</span>
                        <span class="data-value">${point.region || 'Не указан'}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Технологии:</span>
                        <span class="data-value">${point.technologies || 'Не указаны'}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Статус:</span>
                        <span class="data-value">${point.status || 'Активна'}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Адрес:</span>
                        <span class="data-value">${point.address || 'Не определен'}</span>
                    </div>
                `;
                existingElement.classList.add('active');
                existingElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                // Создаем новый элемент с данными точки
                const pointElement = document.createElement('div');
                pointElement.className = 'point-data active';
                pointElement.dataset.pointId = point.id;
                
                pointElement.innerHTML = `
                    <h3>${point.title || 'Точка связи'}</h3>
                    <div class="data-item">
                        <span class="data-label">ID объекта:</span>
                        <span class="data-value">${point.objectId || 'Не указан'}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Широта:</span>
                        <span class="data-value">${point.lat.toFixed(6)}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Долгота:</span>
                        <span class="data-value">${point.lng.toFixed(6)}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Регион:</span>
                        <span class="data-value">${point.region || 'Не указан'}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Технологии:</span>
                        <span class="data-value">${point.technologies || 'Не указаны'}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Статус:</span>
                        <span class="data-value">${point.status || 'Активна'}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Адрес:</span>
                        <span class="data-value">${point.address || 'Не определен'}</span>
                    </div>
                `;
                
                // Добавляем обработчик клика для выделения точки на карте
                pointElement.addEventListener('click', function() {
                    highlightPointOnMap(point.id);
                });
                
                // Добавляем данные в начало контейнера
                dataContainer.insertBefore(pointElement, dataContainer.firstChild);
                
                // Если слишком много элементов, удаляем самый старый
                if (dataContainer.children.length > 15) {
                    dataContainer.removeChild(dataContainer.lastChild);
                }
            }
            
            // Обновляем заголовок левой панели
            document.getElementById('left-panel-title').textContent = `Анализ измерений (${points.length})`;
            activePointId = point.id;
        }
        
        // Функция для выделения точки на карте
        function highlightPointOnMap(pointId) {
            const point = points.find(p => p.id === pointId);
            if (point && point.marker) {
                // Центрируем карту на точке
                map.setView([point.lat, point.lng], 17);
                
                // Открываем попап
                point.marker.openPopup();
                
                // Анимируем маркер
                const icon = point.marker.getElement();
                if (icon) {
                    icon.style.animation = 'pulse 0.5s 3';
                    setTimeout(() => {
                        icon.style.animation = '';
                    }, 1500);
                }
            }
        }
        
        // Функция для создания кастомной иконки сотового телефона
        function createCellIcon(color = '#3b82f6') {
            return L.divIcon({
                className: 'custom-cell-icon',
                html: `<div class="cell-icon" style="background-color: ${color};"><i class="fas fa-mobile-screen"></i></div>`,
                iconSize: [36, 36],
                iconAnchor: [18, 18],
                popupAnchor: [0, -18]
            });
        }
        
        // Функция получения адреса по координатам (обратное геокодирование)
        async function getAddressFromCoordinates(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                
                if (data && data.address) {
                    const address = data.address;
                    let addressStr = '';
                    
                    if (address.road) addressStr += address.road;
                    if (address.house_number) addressStr += `, ${address.house_number}`;
                    if (!addressStr && address.city) addressStr = address.city;
                    
                    return addressStr || 'Адрес не найден';
                }
                return 'Адрес не найден';
            } catch (error) {
                console.error('Ошибка получения адреса:', error);
                return 'Ошибка получения адреса';
            }
        }
        
        function getViewportCoordinates() {
            // Получаем границы текущего viewport карты
            const bounds = map.getBounds();
            
            // Получаем северо-западный угол (левый верхний)
            const northWest = bounds.getNorthWest();
            // Получаем юго-восточный угол (правый нижний)
            const southEast = bounds.getSouthEast();
            
            // Формируем дату (сегодняшний день и месяц, текущий год)
            const today = new Date();
            const currentYear = today.getFullYear();
            // Форматируем дату в ISO строку (можно изменить формат при необходимости)
            const formattedDate = `${currentYear}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            // Создаем объект с данными для запроса
            const rectangleData = {
                up_lat: northWest.lat,    // Северная широта левого верхнего угла
                up_lon: northWest.lng,    // Восточная долгота левого верхнего угла
                down_lat: southEast.lat,  // Северная широта правого нижнего угла
                down_lon: southEast.lng,  // Восточная долгота правого нижнего угла
                dtime: formattedDate       // Дата в формате YYYY-MM-DD
            };
            
            return rectangleData;
        }


        // Функция для выполнения запроса к /measure/view
        async function fetchMeasurementsInViewport() {
            try {
                // Получаем координаты viewport
                const viewportData = getViewportCoordinates();
                
                console.log('Координаты viewport:', viewportData);
                
                // Выполняем POST запрос
                const response = await fetch('/measure/view', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Добавьте авторизацию если нужно
                        // 'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify(viewportData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const measurements = await response.json();
                return measurements;
                
            } catch (error) {
                console.error('Ошибка при получении измерений:', error);
                throw error;
            }
        }


        // Функция для обновления точек на карте
        async function updateMapPoints() {
            try {
                const viewportData = getViewportCoordinates();
                const response = await fetch('/measure/view', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(viewportData)
                });
                
                const measurements = await response.json();
                
                markersLayer.clearLayers();
                points = [];
                
                /*
                // Добавляем новые маркеры
                measurements.forEach(point => {
                    L.marker([point.lat, point.lon])
                        .addTo(window.markerLayer)
                        .bindPopup(`
                            <b>ID:</b> ${point.id}<br>
                            <b>Device:</b> ${point.device_id}<br>
                            <b>Скорость:</b> ${point.download}/${point.upload}
                        `);
                });
                */

                measurements.forEach(point => {
                    addPointToMap(point);
                });
                
                console.log(`Обновлено ${measurements.length} точек`);
                
            } catch (error) {
                console.error('Ошибка при обновлении точек:', error);
            }
        }


        // Инициализация карты
        async function initMap() {
            // Устанавливаем центр на Таганрог (45.2052, 38.9407)
            map = L.map('map').setView([47.2052, 38.9407], 15);
            
            // Добавляем несколько источников карт
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            });
            
            const osmHotLayer = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors, Tiles style by Humanitarian OpenStreetMap Team',
                maxZoom: 19
            });
            
            const cartoDbLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap, © CartoDB',
                subdomains: 'abcd',
                maxZoom: 19
            });
            
            // Добавляем слой по умолчанию
            osmLayer.addTo(map);
            
            // Добавляем контроль слоев
            const baseLayers = {
                "OpenStreetMap": osmLayer,
                "OpenStreetMap H.O.T.": osmHotLayer,
                "CartoDB Light": cartoDbLayer
            };
            
            L.control.layers(baseLayers).addTo(map);
            
            // Создаем слой для маркеров
            markersLayer = L.layerGroup().addTo(map);
            
            // Добавляем информацию о координатах
            const coordsInfo = L.control({position: 'bottomleft'});
            coordsInfo.onAdd = function() {
                this._div = L.DomUtil.create('div', 'coordinates-info');
                this.update();
                return this._div;
            };
            coordsInfo.update = function(latlng) {
                if (latlng) {
                    this._div.innerHTML = `Широта: ${latlng.lat.toFixed(6)}<br>Долгота: ${latlng.lng.toFixed(6)}`;
                } else {
                    this._div.innerHTML = 'Кликните на карту для координат';
                }
            };
            coordsInfo.addTo(map);
            
            // Обновляем координаты при движении мыши по карте
            map.on('mousemove', function(e) {
                coordsInfo.update(e.latlng);
            });

            let initialPoints = await fetchMeasurementsInViewport();
            console.log(initialPoints);
            
            
            /*
            // Добавляем две начальные точки в Таганроге с адресами
            const initialPoints = [
                {
                    id: 1,
                    lat: 47.2052,
                    lng: 38.9407,
                    title: 'Измерение',
                    objectId: 'ТГР-ЦЕНТР',
                    region: 'Таганрог, Ростовская область',
                    technologies: '4G, LTE, 5G',
                    status: 'Активна',
                    address: 'ул. Петровская, 10'
                },
                {
                    id: 2,
                    lat: 47.2050,
                    lng: 38.9404,
                    title: 'Измерение',
                    objectId: 'ТГР-СЕВЕР',
                    region: 'Таганрог, Ростовская область',
                    technologies: '3G, 4G, Wi-Fi',
                    status: 'В разработке',
                    address: 'пр-т Ленина, 45'
                }
            ];
            */
            
            // Добавляем начальные точки на карту
            initialPoints.forEach(async point => {
                points.push(point);
                await addPointToMap(point);
                showPointData(point);
            });
            
            /*
            // Обработчик клика по карте для добавления новых точек
            map.on('click', async function(e) {
                currentPointId++;
                const address = await getAddressFromCoordinates(e.latlng.lat, e.latlng.lng);
                
                const newPoint = {
                    id: currentPointId,
                    lat: e.latlng.lat,
                    lng: e.latlng.lng,
                    title: `Новая точка связи #${currentPointId}`,
                    objectId: `АВТО-${currentPointId.toString().padStart(3, '0')}`,
                    region: 'Таганрог, Ростовская область',
                    technologies: '2G, 3G, 4G',
                    status: 'Новая',
                    address: address
                };
                
                await addPointToMap(newPoint);
                showPointData(newPoint);
                
                // Центрируем карту на новой точке с увеличением
                map.setView([newPoint.lat, newPoint.lng], 17);
            });
            */

            // Вешаем несколько событий на карту
            map.on('moveend', function(e) {
                console.log('Перемещение карты завершено');
                updateMapPoints();
            });

            map.on('zoomend', function(e) {
                console.log('Изменение масштаба завершено');
                updateMapPoints();
            });
            
            /*
            // Кнопка очистки всех точек
            document.getElementById('clear-points').addEventListener('click', function() {
                if (confirm('Вы уверены, что хотите удалить все точки?')) {
                    markersLayer.clearLayers();
                    points = [];
                    currentPointId = 2;
                    document.getElementById('point-data-container').innerHTML = '';
                    document.getElementById('left-panel-title').textContent = 'Данные по точкам (0)';
                    activePointId = null;
                }
            });
            */
            
            return { map, markersLayer };
        }
        
        // Функция для добавления точки на карту
        async function addPointToMap(point) {
            // Определяем цвет маркера в зависимости от статуса
            let markerColor = '#3b82f6'; // Синий по умолчанию
            if (point.status === 'Активна') markerColor = '#10b981'; // Зеленый
            if (point.status === 'В разработке') markerColor = '#f59e0b'; // Желтый
            if (point.status === 'Новая') markerColor = '#8b5cf6'; // Фиолетовый
            
            // Создаем маркер с иконкой сотового телефона
            const marker = L.marker([point.lat, point.lon], {
                icon: createCellIcon(markerColor)
            }).addTo(markersLayer);
            
            // Сохраняем ссылку на маркер в объекте точки
            point.marker = marker;
            
            /*
            // Получаем адрес, если его нет
            if (!point.address || point.address === 'Не определен') {
                point.address = await getAddressFromCoordinates(point.lat, point.lon);
            }
            */
            
            // Добавляем всплывающее окно с улучшенным дизайном
            marker.bindPopup(`
                <div class="popup-content">
                    <div class="popup-title">${point.title}</div>
                    <div class="popup-detail">
                        <span class="popup-label">ID:</span>
                        <span class="popup-value">${point.bs_num}</span>
                    </div>
                    <div class="popup-detail">
                        <span class="popup-label">Координаты:</span>
                        <span class="popup-value">${point.lat.toFixed(6)}, ${point.lon.toFixed(6)}</span>
                    </div>
                    <div class="popup-detail">
                        <span class="popup-label">Технологии:</span>
                        <span class="popup-value">${point.technologies}</span>
                    </div>
                    <div class="popup-detail">
                        <span class="popup-label">Статус:</span>
                        <span class="popup-value">${point.status}</span>
                    </div>
                    <div class="popup-detail">
                        <span class="popup-label">Адрес:</span>
                        <span class="popup-value">${point.address}</span>
                    </div>
                </div>
            `);
            
            // Обработчик клика по маркеру
            marker.on('click', function() {
                showPointData(point);
            });
            
            /*
            // Обработчик перемещения маркера
            marker.on('dragend', async function(e) {
                const newLat = e.target.getLatLng().lat;
                const newLng = e.target.getLatLng().lng;
                
                // Обновляем координаты точки
                point.lat = newLat;
                point.lng = newLng;
                
                // Получаем новый адрес
                point.address = await getAddressFromCoordinates(newLat, newLng);
                
                // Обновляем данные в левой панели, если эта точка активна
                if (activePointId === point.id) {
                    showPointData(point);
                }
            });
            */
            
            // Добавляем точку в массив
            points.push(point);
        }
        
        // Функция поиска по адресу
        async function searchAddress() {
            const searchInput = document.getElementById('search-input');
            const query = searchInput.value.trim();
            
            if (!query) return;
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const result = data[0];
                    map.setView([result.lat, result.lon], 17);
                    
                    // Добавляем временный маркер
                    const tempMarker = L.marker([result.lat, result.lon], {
                        icon: L.divIcon({
                            html: '<div style="background-color: #ef4444; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map);
                    
                    tempMarker.bindPopup(`<b>Найдено:</b><br>${result.display_name}`).openPopup();
                    
                    // Удаляем маркер через 5 секунд
                    setTimeout(() => {
                        map.removeLayer(tempMarker);
                    }, 5000);
                } else {
                    alert('Адрес не найден');
                }
            } catch (error) {
                console.error('Ошибка поиска:', error);
                alert('Ошибка при поиске адреса');
            }
        }
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализируем карту
            const { map: leafletMap, markersLayer } = initMap();
            
            // Добавляем поиск
            const searchContainer = document.createElement('div');
            searchContainer.className = 'search-container';
            searchContainer.innerHTML = `
                <input type="text" 
                    id="search-input" 
                    class="search-input" 
                    placeholder="Поиск адреса или места..."
                    onkeypress="if(event.key === 'Enter') searchAddress()">
            `;
            document.querySelector('.map-container').appendChild(searchContainer);
            
            // Добавляем анимацию пульсации
            const style = document.createElement('style');
            style.textContent = `
                @keyframes pulse {
                    0% { transform: scale(1); }
                    50% { transform: scale(1.2); }
                    100% { transform: scale(1); }
                }
            `;
            document.head.appendChild(style);
        });
    </script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

{% include "foot.html" %}